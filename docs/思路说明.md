# 数字版权隐写演示：LSB + 样本对分析（SPA）+ ±1 匹配

本文档给出本仓库实现的整体思路、使用方法与可视化/分析指标解释，并逐题给出作答框架。

## 总体思路
- 载体：仅使用 `data/B题-附件1.jpg`。
- 模块化：
  - 加密器（embedder）：`src/encryptor.py`，支持 LSB 置换与 LSB matching（±1），支持按密钥像素打乱，记录直方图 KL、LSB 平面统计。
  - 解析器（parser）：`src/parser.py`，按密钥恢复消息；可在解析前注入压缩/缩放/旋转/模糊等模拟扰动。
  - 分析与可视化：`src/analysis.py` 提供 LSB 平面、直方图、卡方与样本对分析（SPA）估计；`src/viz.py` 绘图。
  - 扰动模块：`src/perturb.py`，模拟 JPEG 压缩等常见破坏。

## 算法要点
- LSB 置换（replace）：将消息比特直接替换选中像素的最低有效位（LSB）。
- LSB 匹配（match/±1）：当 LSB 不等于目标比特时，以 0.5 概率 ±1 修改像素值，避免简单偶奇对称被强特征检测。
- 像素顺序：使用密钥经 SHA-256 派生随机序列打乱全图与通道上的索引，提升安全性与均匀性。
- 头部：前 32bit 为消息字节长度，便于解析端确定边界。

## 指标与可视化
- 直方图 KL 散度（before→after）：衡量嵌入对像素分布的偏移。
- LSB 平面可视化：前后对比观察低位随机化程度。
- 卡方攻击统计（Westfeld χ²）：对 (2i,2i+1) 成对桶评估是否接近均衡。
- 样本对分析（SPA）嵌入率估计：基于相邻像素对的简化估算，展示“可被检测的特征”。

## 使用说明
1) 加密（嵌入）：
   - 输入：`--input data/B题-附件1.jpg`，消息 `--message`，密钥 `--key`。
   - 可选：`--mode replace|match`，`--channel ALL|R|G|B`，`--figdir figs/` 输出图，`--report out.json` 输出指标。
2) 解析（提取）：
   - 输入：`--input stego.png --key <密钥>`，可注入 `--jpeg 85`、`--resize 0.5` 等扰动后再提取。

示例脚本：`scripts/demo_lsb.py` 会端到端生成图像与图表，并打印 KL、χ²、SPA、恢复文本。

## 容量与题意对应
- 尺寸 W×H、使用 C 个通道，则理论容量约为 W×H×C bit，实际略少（32bit 头部）。可按本图尺寸给出最大可嵌入字符数上限≈(W×H×C−32)/8。

## 问题作答框架（草案）
- 问题1（模型与算法）：本实现给出 LSB/LSBM 两种空域隐写模型与密钥打乱调度，图像视觉近似不变；提供可重复的源码与生成结果，A/B 附录分别放入嵌入与提取源代码。
- 问题2（能否嵌入整部法律文本）：统计 `airef/法案.md` 字符字节数，与容量进行对比；若超出，给出可嵌入最大字节数，并展示截断或分块方案。
- 问题3（鲁棒性）：通过 `parser.py --jpeg/--resize/--rotate/--blur` 实测，说明 LSB 空域方法对有损压缩与几何变换不鲁棒；提出改进（频域嵌入、纠删/重同步、扩频、同步标记、变换不变特征等）。
- 问题4（扩展到其他图片的注意事项）：
  1) 嵌入率控制：纹理区优先、降低平均嵌入率，使用 ±1 匹配减弱统计痕迹。
  2) 格式链路：避免 JPEG 再压缩，建议以 PNG/BMP 传输保存，或改用 JPEG 域隐写。
  3) 密钥与审计：密钥派生、像素置乱、防复用；记录哈希与水印证据链以便取证。

## 目录与文件
- `src/lsb.py`：嵌入/提取核心；输出 KL 与 LSB 统计。
- `src/analysis.py`：χ² 与 SPA 估计。
- `src/perturb.py`：压缩/缩放/旋转/模糊。
- `src/viz.py`：直方图与 LSB 平面图。
- `src/encryptor.py`、`src/parser.py`：命令行工具。
- `scripts/demo_lsb.py`：端到端演示。

## 局限与下一步
- LSB 空域方法对 JPEG 压缩等不鲁棒；可扩展为 JPEG 域（J-UNIWARD 等）或学习型隐写。
- 可加入纠删编码、重复扩频减少丢失风险；可实现区域自适应嵌入以降低可检性。
